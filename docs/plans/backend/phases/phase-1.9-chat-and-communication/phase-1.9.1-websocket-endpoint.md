# Phase 1.9.1: WebSocket Endpoint

**Parent Goal:** Phase 1.9 Chat & Communication Layer
**Checklist:**
- [x] 1.9.1 WebSocket Endpoint
- [ ] 1.9.2 Edge Agent WebSocket Client
- [ ] 1.9.3 Message Persistence
- [ ] 1.9.4 Edge Agent Chat Repository
- [ ] 1.9.5 Chat UI in Harness
- [ ] 1.9.6 Push Notifications (FCM)
- [ ] 1.9.7 Edge Agent FCM Setup

---

## What
Implement a WebSocket endpoint in FastAPI that handles full-duplex communication between the Client and the Orchestrator.

## Why
HTTP polling is inefficient for chat. WebSockets allow the server to "push" tokens as they are generated by the LLM (streaming), making the app feel faster.

## How
Use FastAPI's `WebSocket` support. Authenticate the connection via a query parameter token (standard pattern for WS).

## Features
- **Streaming:** Relays tokens from LLM to Client in real-time.
- **Connection Management:** Handles disconnects and reconnections gracefully.

## Files
- Modify: `cloud-brain/app/api/v1/chat.py`

## Steps

1. **Create WebSocket chat endpoint (`cloud-brain/app/api/v1/chat.py`)**

```python
from fastapi import APIRouter, WebSocket, WebSocketDisconnect, Depends
# from cloudbrain.app.auth import get_current_user_ws
# from cloudbrain.app.agent.orchestrator import Orchestrator

router = APIRouter()

@router.websocket("/ws/chat")
async def websocket_chat(
    websocket: WebSocket,
    # user: User = Depends(get_current_user_ws) # Auth via query param
):
    await websocket.accept()
    # orchestrator = Orchestrator(user)
    
    try:
        while True:
            data = await websocket.receive_json()
            message = data.get("message")
            
            # 1. Save user message to DB (async)
            
            # 2. Process via Orchestrator
            # async for chunk in orchestrator.stream_response(message):
            #     await websocket.send_json({"type": "chunk", "content": chunk})
            
            # Mock echo for now:
            await websocket.send_json({
                "type": "message",
                "content": "Echo: " + message
            })
            
            # 3. Save assistant message to DB
            
    except WebSocketDisconnect:
        print("Client disconnected")
```

## Exit Criteria
- Endpoint accepts socket connections.
- Echoes messages back.
